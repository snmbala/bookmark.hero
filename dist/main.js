function ie(){const t=document.documentElement,o=document.getElementById("settings-icon-svg");o&&(t.classList.contains("dark")?o.querySelectorAll("path").forEach(a=>{a.setAttribute("stroke","#a5b4fc")}):o.querySelectorAll("path").forEach(a=>{a.setAttribute("stroke","#4f46e5")}))}function Ce(){const t=document.querySelectorAll(".theme-toggle-btn");if(!t.length)return;const o=document.documentElement;function a(c){chrome?.storage?.sync?chrome.storage.sync.get(["appearanceMode"],u=>c(u.appearanceMode||"auto")):c(localStorage.getItem("appearanceMode")||"auto")}function i(c){chrome?.storage?.sync?chrome.storage.sync.set({appearanceMode:c}):localStorage.setItem("appearanceMode",c)}function s(c){t.forEach((u,v)=>{u.classList.remove("bg-indigo-50","border-2","border-indigo-400","text-indigo-700","bg-white","text-zinc-500","dark:bg-indigo-500/10","dark:border-indigo-400","dark:text-indigo-200","dark:bg-zinc-700","dark:text-zinc-300","rounded-l-md","rounded-r-md"),u.classList.add("bg-white","text-zinc-500","dark:bg-zinc-700","dark:text-zinc-300"),v===0&&u.classList.add("rounded-l-md"),v===t.length-1&&u.classList.add("rounded-r-md"),c==="auto"&&u.getAttribute("data-theme")==="auto"||c==="light"&&u.getAttribute("data-theme")==="light"||c==="dark"&&u.getAttribute("data-theme")==="dark"?(u.classList.remove("bg-white","text-zinc-500","dark:bg-zinc-700","dark:text-zinc-300"),u.classList.add("bg-indigo-50","border-2","border-indigo-400","text-indigo-700","dark:bg-indigo-500/10","dark:border-indigo-400","dark:text-indigo-200")):u.classList.remove("border-2","border-indigo-400","text-indigo-700","dark:bg-indigo-500/10","dark:border-indigo-400","dark:text-indigo-200")})}function d(c){c==="dark"?o.classList.add("dark"):c==="light"?o.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches?o.classList.add("dark"):o.classList.remove("dark"),ie()}a(c=>{s(c),d(c)}),t.forEach(c=>{c.addEventListener("click",()=>{const u=c.getAttribute("data-theme");i(u),s(u),d(u)})}),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",c=>{a(u=>{u==="auto"&&d("auto")})})}function be(t,o,a){if(!t){console.error("URL is empty");return}const i=1024,s=683;chrome.windows.create({url:t,type:"popup",width:i,height:s,left:Math.round((screen.width-i)/2),top:Math.round((screen.height-s)/2)},function(d){d.tabs[0].id,chrome.tabs.onUpdated.addListener(function c(u,v){u===u&&v.status==="complete"&&(chrome.tabs.onUpdated.removeListener(c),setTimeout(function(){chrome.tabs.captureVisibleTab(d.id,{format:"png"},function(B){B?Le(B,100,function(b){Ie(t,b),a&&typeof a=="function"&&a(t,b)}):console.error("Failed to capture screenshot for URL:",t),chrome.windows.remove(d.id)})},1e3))})})}function Le(t,o,a){const i=new Image;i.src=t,i.onload=function(){const s=document.createElement("canvas"),d=s.getContext("2d");s.width=1024,s.height=683,d.drawImage(i,0,0,s.width,s.height);let c=1;for(;;){const u=s.toDataURL("image/jpeg",c);if(u.length/1024<=o||c<=.1){a(u);break}else c-=.1}}}function Ie(t,o){const a=t,i=o;chrome.storage.local.set({[a]:i},function(){chrome.runtime.lastError&&console.error(chrome.runtime.lastError.message)})}function pe(t,o){const a=t;chrome.storage.local.get([a],function(i){if(chrome.runtime.lastError)o(`https://www.google.com/s2/favicons?domain=${t}`);else{const s=i[a];o(s||`https://www.google.com/s2/favicons?domain=${t}`)}})}function Be(t,o,a=null,i=null){console.log("📸 Starting centralized screenshot capture for:",o,"URL:",t),be(t,o,function(s,d){console.log("📸 Screenshot capture completed for:",o),document.querySelectorAll(".card").forEach(u=>{if(u.querySelector('a[href="'+t+'"]')){const B=u.querySelector('img[alt="'+t+'"]');B&&(B.src=d,console.log("🖼️ Updated thumbnail for:",o)),Se(u,t)}}),i&&i.parentNode&&(i.parentNode.removeChild(i),console.log("🗑️ Removed specific capture button for:",o))})}function Se(t,o){const a=t.querySelector("#capture-"+o.replace(/[^a-zA-Z0-9]/g,""));if(a){a.remove(),console.log("🗑️ Removed capture button by ID");return}t.querySelectorAll("button").forEach(s=>{s.textContent==="Capture Thumbnail"&&(s.remove(),console.log("🗑️ Removed capture button by text content"))})}chrome.bookmarks.getTree(function(t){const o=document.getElementById("folder-list"),a=document.getElementById("search-input"),i=document.getElementById("clear-search"),s=document.getElementById("search-icon"),d=document.getElementById("filter"),c=document.getElementById("folder-view"),u=document.getElementById("recents-view"),v=document.getElementById("recents-icon"),B=document.getElementById("settings-btn");let b=0,L=!0,x=[],A=[{label:"All",value:"all",level:0,id:0}],q={data:null,timestamp:0};const ye=5e3;function ve(e,n){let r;const l=function(...f){const h=()=>{clearTimeout(r),e(...f)};clearTimeout(r),r=setTimeout(h,n)};return l.cancel=function(){clearTimeout(r)},l}function se(){const e=Date.now();return q.data&&e-q.timestamp<ye?Promise.resolve(q.data):new Promise(n=>{chrome.bookmarks.getTree(r=>{q.data=r,q.timestamp=e,n(r)})})}Ce(),document.addEventListener("DOMContentLoaded",ie),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",ie);let K=!1;const O=document.getElementById("settings-modal");B.addEventListener("click",function(e){e.stopPropagation(),O.classList.toggle("hidden"),K=!O.classList.contains("hidden"),K&&setTimeout(()=>{const n=document.querySelector('button[data-theme="auto"]');n&&(n.focus(),console.log("🎯 Focused Auto theme button in settings modal"))},100)}),O.addEventListener("click",function(e){e.stopPropagation()}),document.addEventListener("click",function(){K&&!O.classList.contains("hidden")&&(O.classList.add("hidden"),K=!1)});function J(e,n=""){if(e.children){n=e.title;for(const r of e.children)J(r,n)}else x.push({bookmark:e,folder:n})}for(const e of t[0].children)J(e);let _=x.sort((e,n)=>{const r=e.bookmark.dateLastUsed||e.bookmark.dateAdded;return(n.bookmark.dateLastUsed||n.bookmark.dateAdded)-r});const H=ve(function(e){L?T(e):F(t,e)},300);a.addEventListener("input",function(){if(a.value){i.classList.remove("hidden"),document.activeElement===a?s.src="assets/icons/search-blue.svg":s.src="assets/icons/search.svg";const e=a.value.trim().toLowerCase();H(e)}else H.cancel&&H.cancel(),i.classList.add("hidden"),s.src="assets/icons/search.svg",L?T(""):F(t,"")}),i.addEventListener("click",function(){a.value="",H.cancel&&H.cancel(),i.classList.add("hidden"),s.src="assets/icons/search.svg",L?T(""):F(t,"")});function ce(){L=!L,a.value="",i.classList.add("hidden"),s.src="assets/icons/search.svg",d.value="all",b=0,j();const e="",n=document.querySelectorAll(".folder-icon"),r=document.getElementById("settings-icon-svg");L?(n.forEach(l=>{l.style.fill="none",l.style.stroke="#a1a1aa"}),c.classList.remove("active"),c.classList.add("in-active"),v.style.fill="#4f46e5",v.style.stroke="#4f46e5",u.classList.add("active"),u.classList.remove("in-active"),r&&r.querySelectorAll("path").forEach(l=>{l.setAttribute("stroke","#4f46e5")}),T(e)):(n.forEach(l=>{l.style.fill="#4f46e5",l.style.stroke="#4f46e5"}),c.classList.add("active"),c.classList.remove("in-active"),v.style.stroke="#a1a1aa",v.style.fill="none",u.classList.remove("active"),u.classList.add("in-active"),r&&r.querySelectorAll("path").forEach(l=>{l.setAttribute("stroke","#a1a1aa")}),F(t,e))}function T(e){_=x.sort((m,p)=>{const y=m.bookmark.dateLastUsed||m.bookmark.dateAdded;return(p.bookmark.dateLastUsed||p.bookmark.dateAdded)-y});let n=_.filter(m=>{const p=!e||U(m.bookmark.title,e)||U(m.bookmark.url,e);if(b&&b!==0&&b!=="all"){const y=m.bookmark.parentId==b;return p&&y}return p});o.innerHTML="",document.querySelectorAll("[data-scroll-handler]").forEach(m=>{m.scrollHandler&&window.removeEventListener("scroll",m.scrollHandler)});const l=document.createElement("h1");l.textContent=te(e,b,n.length),l.className="flex-start w-full font-semibold text-lg py-2 text-zinc-800 dark:text-zinc-50";const f=document.createElement("div");f.className="w-fit",o.appendChild(f);const h=document.createElement("div");h.className="container mx-auto grid my-6 grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-8",f.appendChild(l),f.appendChild(h);const g=100;let w=0,k=!1;h.setAttribute("data-scroll-handler","true");function E(){if(k)return;k=!0;const m=w*g,p=Math.min(m+g,n.length),y=document.createDocumentFragment();for(let D=m;D<p;D++){const N=n[D];if(!N.children){const X=ee(N.bookmark,e,N.folder);y.appendChild(X)}}h.appendChild(y),w++,k=!1,window.updateBookmarkCards&&window.updateBookmarkCards()}function C(){const m=()=>{window.innerHeight+window.scrollY>=document.documentElement.scrollHeight-200&&w*g<n.length&&!k&&E()};window.addEventListener("scroll",m),h.scrollHandler=m}if(n.length>0&&(E(),n.length>g&&C()),n.length===0){const m=document.createElement("p");m.textContent=e?`No bookmarks found matching "${e}"`:"No bookmarks found.",m.className="text-zinc-500 dark:text-zinc-400 mt-4",f.appendChild(m)}}function ee(e,n,r=null){const l=document.createElement("div");l.className="card",l.setAttribute("tabindex","0"),l.setAttribute("data-parent-id",e.parentId||"1"),l.setAttribute("data-bookmark-id",e.id),l.setAttribute("data-bookmark-url",e.url),l.addEventListener("keydown",function(S){if(document.activeElement===l)if(S.key==="Enter")S.preventDefault(),e.url&&window.open(e.url,"_blank");else if(S.key.toLowerCase()==="m"){S.preventDefault();const z=l.querySelector(".close-button");z&&(z.click(),setTimeout(()=>{l.focus()},200))}else["ArrowLeft","ArrowRight","ArrowUp","ArrowDown"].includes(S.key)});const f=document.createElement("button");f.className="absolute top-0 right-0 m-1 p-1 bg-zinc-500 hover:bg-zinc-600 dark:bg-zinc-700 dark:hover:bg-zinc-800 rounded-full border-none cursor-pointer close-button",f.setAttribute("aria-label","More actions for "+e.title),f.addEventListener("click",function(S){S.stopPropagation(),ae(S,e)});const h=document.createElement("img");h.src="assets/icons/more.svg",h.alt="Close",h.className="h-4 w-4",f.appendChild(h),l.appendChild(f);const g=document.createElement("a");g.href=e.url,g.target="_blank",g.className="flex-center flex-col gap-3 card-thumbnail w-full h-40 border-b-[1.5px] bg-zinc-100 dark:bg-zinc-700 dark:border-zinc-600",pe(e.url,function(S){const z=document.createElement("img");if(z.src=S,z.alt=e.url||"Bookmark thumbnail",g.appendChild(z),e.title,S.startsWith("https://www.google.com/s2/favicons?domain=")){const I=document.createElement("button");I.textContent="Capture Thumbnail",I.className="text-zinc-800 dark:text-zinc-200 border-zinc-300 dark:border-zinc-700 bg-white hover:bg-zinc-50 dark:bg-zinc-800 dark:hover:bg-zinc-900 font-semibold py-2 px-4 border shadow rounded-full",I.id="capture-"+e.url,I.addEventListener("click",function($){$.preventDefault(),window.handleScreenshotCapture(e.url,e.title,null,I)}),g.appendChild(I)}}),l.appendChild(g),g.addEventListener("click",function(S){const z=new Date().getTime();for(const I of x)if(I.bookmark.id===e.id){I.bookmark.dateLastUsed=z;break}});const w=document.createElement("div");w.className="flex-center h-24 flex-col bg-white dark:bg-zinc-800 px-2 py-4";const k=document.createElement("div");k.className="flex-start w-full h-5";const E=document.createElement("a");E.className="flex-start text-base font-medium text-zinc-800 dark:text-zinc-50 whitespace-nowrap overflow-hidden text-ellipsis",E.href=e.url,E.target="_blank",E.innerHTML=G(e.title||"Untitled",n),k.appendChild(E),E.addEventListener("click",function(S){const z=new Date().getTime();for(const I of x)if(I.bookmark.id===e.id){I.bookmark.dateLastUsed=z;break}}),w.appendChild(k),setTimeout(()=>{E.offsetWidth>216&&k.classList.add("text-scroll")},0);const C=document.createElement("div");C.className="flex-start w-full h-5 overflow-hidden";const m=document.createElement("p");m.className="flex-start text-zinc-800 dark:text-zinc-300 whitespace-nowrap",m.title=e.url;const p=new URL(e.url);let y=p.hostname.replace(/^www\./,"");const D=p.pathname;if(D&&D!=="/"?y=G(y,n)+`<span class="text-zinc-400 whitespace-nowrap">${G(D,n)}</span>`:y=G(y,n),m.innerHTML=y,C.appendChild(m),w.appendChild(C),L){let S="";const z=x.find(I=>I.bookmark.id===e.id);if(z&&z.folder)S=z.folder;else{const I=A.find($=>$.value===e.parentId);I&&(S=I.label.replace(/^[-\s]+/,""))}if(S){const I=document.createElement("div");I.className="flex-start w-full mt-1";const $=document.createElement("span");$.textContent=S,$.className="flex-center w-fit h-5 px-2 py-0.5 rounded-md bg-zinc-200 dark:bg-zinc-700 dark:text-zinc-50 border border-zinc-300 dark:border-zinc-600 text-xs font-medium",I.appendChild($),w.appendChild(I)}}l.appendChild(w);const N=e.title||"Untitled";let X=N;r&&r.trim()&&(X=`${r} - ${N}`),l.setAttribute("aria-label",X),l.setAttribute("role","link"),l.setAttribute("aria-describedby",`bookmark-url-${e.id}`);const Z=document.createElement("span");return Z.id=`bookmark-url-${e.id}`,Z.className="sr-only",Z.textContent=`URL: ${e.url}`,l.appendChild(Z),l}u.addEventListener("click",ce),c.addEventListener("click",ce),d.addEventListener("change",function(e){b=e.target.value=="all"?0:e.target.value;const n=a.value.trim().toLowerCase();j(),L?T(n):F(t,n)});function U(e,n){return!e||!n?!1:n.toLowerCase().split(" ").every(l=>e.toLowerCase().includes(l))}function G(e,n){if(!n||!e)return e;const r=n.toLowerCase().split(/\s+/).filter(f=>f.length>0);let l=e;return r.forEach(f=>{const h=new RegExp(`(${f})`,"gi");l=l.replace(h,'<mark class="bg-yellow-200 dark:bg-yellow-600 dark:text-zinc-100 px-0.5 rounded-sm">$1</mark>')}),l}function te(e,n,r){const l=e&&e.trim().length>0,f=n&&n!==0&&n!=="all";let h="",g="";if(f){const w=A.find(k=>k.value==n);w&&(h=w.label.replace(/^[\s\-]*/,""),g=h.includes("- ")?h.replace(/\s*-\s*/g," > "):h)}return l&&f?r===0?`No results for "${e}" in ${g}`:`Results for "${e}" in ${g} (${r})`:l?r===0?`No results for "${e}"`:`Results for "${e}" (${r})`:f?`Folder: ${g} (${r})`:L?`Recent Bookmarks (${r})`:`Bookmarks (${r})`}function Pe(e,n){}let M=null,R=null;function ae(e,n){M&&M.remove(),R=n;const r=document.getElementById("folder-dropdown");if(r&&r.children.length===0&&A.slice(1).forEach(function(w){const k=document.createElement("option");k.value=w.value,k.textContent=w.label,k.selected=w.value===R.parentId,r.appendChild(k)}),M&&M.previousElementSibling===e.target){M.remove(),M=null;return}if(M){g();return}const l=document.createElement("div");l.className="absolute z-10 flex flex-col bg-zinc-800 w-44 h-32 rounded shadow-md text-zinc-100 hover:text-zinc-50 text-sm font-light flex-center flex-col";function f(w,k,E,C){const m=document.createElement("div");m.className="flex-start w-full h-9 px-3 py-1.5 hover:bg-zinc-700 active:bg-zinc-700";const p=document.createElement("img");p.src=k,p.alt=w,p.className="w-4 h-4 mr-3",m.appendChild(p);const y=document.createElement("button");return y.textContent=w,y.className=E||"flex-start text-left",y.addEventListener("click",C),m.appendChild(y),m}pe(n.url,function(w){const k=w.startsWith("https://www.google.com/s2/favicons?domain=")?"Capture Thumbnail":"Recapture",E=f(k,"assets/icons/camera.svg",null,function(p){p.preventDefault(),window.handleScreenshotCapture(n.url,n.title),g()});l.appendChild(E);const C=f("Edit","assets/icons/edit.svg",null,function(p){g(),p.preventDefault(),de(n)});l.appendChild(C);const m=f("Delete","assets/icons/trash.svg","flex-grow text-left",function(p){p.preventDefault(),confirm("Are you sure you want to delete this bookmark?")&&ue(n),g()});l.appendChild(m)});const h=e.target.getBoundingClientRect();l.style.top=`${h.bottom+window.scrollY+4}px`,l.style.right=`${window.innerWidth-h.right-4}px`,document.body.appendChild(l),M=l;function g(){M&&(M.remove(),M=null,document.removeEventListener("click",g))}document.addEventListener("click",g),e.stopPropagation()}window.showPopupMenu=ae,window.openEditModal=de,window.closeEditModal=W,window.deleteBookmark=ue,window.captureScreenshot=be,window.handleScreenshotCapture=Be,window.getBookmarkFromCard=function(e){const n=e.querySelector("a");if(!n||!n.href)return null;let r="";const l=e.querySelector(".flex-center.h-24.flex-col");if(l){const w=l.querySelector('a[target="_blank"]');w&&(r=w.textContent.trim())}if(!r){const w=e.getAttribute("aria-label")||"";w.includes(" - ")?r=w.split(" - ").slice(1).join(" - ").trim():r=w.trim()}const f=e.getAttribute("data-parent-id"),h=e.getAttribute("data-bookmark-id"),g=e.getAttribute("data-bookmark-url");return console.log("🔍 Extracting bookmark data from card:"),console.log("  ID:",h),console.log("  Title:",r),console.log("  URL:",g),console.log("  Parent ID:",f),{id:h,title:r,url:g,parentId:f}};function de(e){const n=document.getElementById("edit-modal"),r=document.getElementById("edit-title"),l=document.getElementById("edit-url"),f=document.getElementById("folder-dropdown");r.value=e.title||"",l.value=e.url||"",f&&f.children.length===0&&(console.log("📁 Populating folder dropdown..."),A.slice(1).forEach(function(h){const g=document.createElement("option");g.value=h.value,g.textContent=h.label,f.appendChild(g)})),f&&e.parentId&&(console.log("📂 Setting selected folder to:",e.parentId),f.value=e.parentId,f.value!==e.parentId&&console.log("⚠️ Warning: Parent folder not found in dropdown options")),window.currentBookmarkNode=e,window.lastFocusedElement||(window.lastFocusedElement=document.activeElement),n.classList.remove("hidden"),setTimeout(()=>{const h=document.getElementById("edit-title");h&&(h.focus(),h.select(),console.log("🎯 Focused title input in edit modal"))},100)}function W(){document.getElementById("edit-modal").classList.add("hidden"),window.lastFocusedElement&&document.contains(window.lastFocusedElement)?setTimeout(()=>{window.lastFocusedElement.focus(),console.log("🎯 Restored focus to previous element"),window.lastFocusedElement=null},100):setTimeout(()=>{const n=document.querySelector(".card");n&&(n.focus(),console.log("🎯 Focused first bookmark card as fallback")),window.lastFocusedElement=null},100)}function ue(e){const n=e.url;chrome.bookmarks.remove(e.id,function(){console.log(`Deleted bookmark: ${e.title}`),chrome.storage.local.remove([n],function(){x=x.filter(l=>l.bookmark.id!==e.id),_=x.sort((l,f)=>{const h=l.bookmark.dateLastUsed||l.bookmark.dateAdded;return(f.bookmark.dateLastUsed||f.bookmark.dateAdded)-h});const r=a.value.trim().toLowerCase();L?T(r):se().then(function(l){o.innerHTML="",F(l,r)})})})}function fe(e,n=0,r=""){e&&e.length>0&&e.forEach(function(l){l.children?(l.title&&A.push({label:`${n>0?"-".repeat(n-1)+" ":""}`+l.title,value:l.id,level:n,id:r+"-"+l.id+"-"}),fe(l.children,n+1,r+"-"+l.id)):l.parentId&&!A.find(f=>f.value===l.parentId)&&A.push({label:`Unknown Folder (${l.parentId})`,value:l.parentId,level:0,id:`unknown-${l.parentId}`})})}fe(t),A.forEach(function(e){const n=document.createElement("option");n.value=e.value,n.textContent=e.label,n.className="flex-center flex-col bg-zinc-100 w-44 h-32 rounded shadow-md text-zinc-800 text-sm font-normal cursor-pointer py-5",d.appendChild(n)});function j(){const e=document.getElementById("filter"),n=document.getElementById("filter-dropdown-arrow"),r=document.getElementById("filter-clear");e&&n&&r&&(e.value&&e.value!=="all"?(n.classList.add("hidden"),r.classList.remove("hidden")):(n.classList.remove("hidden"),r.classList.add("hidden")))}setTimeout(()=>{const e=document.getElementById("filter"),n=document.getElementById("filter-clear");j(),n&&n.addEventListener("click",function(){if(e){e.value="all",b=0,j();const r=a.value.trim().toLowerCase();L?T(r):F(t,r)}})},100),T("");const me=document.getElementById("cancel-edit"),ge=document.getElementById("save-edit"),ne=document.getElementById("edit-modal");me&&me.addEventListener("click",function(){W()}),ge&&ge.addEventListener("click",function(){if(R){const e=document.getElementById("edit-title"),n=document.getElementById("edit-url"),r=document.getElementById("folder-dropdown"),l=e.value.trim(),f=n.value.trim(),h=r.value;l&&f&&chrome.bookmarks.update(R.id,{title:l,url:f},function(){h!==R.parentId?chrome.bookmarks.move(R.id,{parentId:h},function(){W(),he()}):(W(),he())})}}),ne&&ne.addEventListener("click",function(e){e.target===ne&&W()});function he(){const e=a.value.trim().toLowerCase();q={data:null,timestamp:0},se().then(function(n){x=[];for(const r of n[0].children)J(r);_=x.sort((r,l)=>{const f=r.bookmark.dateLastUsed||r.bookmark.dateAdded;return(l.bookmark.dateLastUsed||l.bookmark.dateAdded)-f}),L?T(e):F(n,e)})}function oe(e){const n=A.find(r=>r.value===e);return n?n.id:`fallback-${e}`}function Y(e,n){let r=0;if(e.children)for(const l of e.children)r+=Y(l,n);else e.url&&(!n||U(e.title,n)||U(e.url,n))&&r++;return r}function xe(e,n,r){const l=e.title,f=Y(e,n),h=n&&n.trim().length>0,g=r&&r!==0&&r!=="all";return f===0?null:h&&g?`${l} - Results for "${n}" (${f})`:h?`${l} - Results for "${n}" (${f})`:g?`${l} (${f})`:`${l} (${f})`}function le(e,n,r,l,f){const h=document.createElement("div");try{h.id=oe(e.id)}catch(g){console.error("Error computing ID for bookmark:",e.title,g),h.id=`fallback-${e.id}`}if(h.className=r||"flex-center flex-col m-auto gap-4",e.children&&e.children.length>0){const g=xe(e,n,b);if(g===null)return null;const w=document.createElement("h2");try{w.id=oe(e.id)}catch(m){console.error("Error computing ID for folder title:",e.title,m),w.id=`fallback-title-${e.id}`}w.textContent=g||"Untitled",w.className=f||"container flex-start w-full text-semibold text-zinc-600 text-lg py-2 dark:text-zinc-200";const k=document.createElement("div");k.className=l||"all-sublist-container";const E=document.createElement("div");try{E.id=oe(e.id)}catch(m){console.error("Error computing ID for noFolderList:",m),E.id=`fallback-nofolder-${e.id}`}E.className="no-folder-list container my-6 gap-x-8 gap-y-6 grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 w-full";let C=[];for(const m of e.children)if(m.children){const p=le(m,n,"sublist-container container w-full flex-center flex-col gap-3","","sublist-title container flex-start w-full text-semibold text-zinc-600 dark:text-zinc-300 text-lg py-2");p&&C.push(p)}else if(m.url&&(!n||U(m.title,n)||U(m.url,n))){const y=ee(m,n,e.title);E.appendChild(y)}return k.appendChild(w),k.appendChild(E),C.forEach(m=>{k.appendChild(m)}),h.appendChild(k),h}return null}function F(e,n){o.innerHTML="";let r=0,l=[];if(e&&e.length>0){const g=e[0];if(b&&b!==0&&b!=="all"){let k=function(C,m){if(C.id===m)return C;if(C.children)for(const p of C.children){const y=k(p,m);if(y)return y}return null};var h=k;const E=k(g,b);if(E){r=Y(E,n);const C=document.createElement("h1");C.textContent=te(n,b,r),C.className="flex-start w-full font-semibold text-lg py-2 text-zinc-800 dark:text-zinc-50",o.appendChild(C);const m=document.createElement("div");if(m.className="no-folder-list container my-6 gap-x-8 gap-y-6 grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 w-full",m.id=`no-folder-list-${b}`,E.children){for(const p of E.children)if(!p.children&&p.url&&(!n||U(p.title,n)||U(p.url,n))){const D=ee(p,n,bookmarkNode.title);m.appendChild(D)}}if(o.appendChild(m),E.children){for(const p of E.children)if(p.children){const y=le(p,n);y&&o.appendChild(y)}}if(r===0){const p=document.createElement("p");p.textContent=n?`No bookmarks found matching "${n}"`:"No bookmarks found.",p.className="text-zinc-500 dark:text-zinc-400 mt-4",o.appendChild(p)}return}}(g.children||[]).forEach(function(k){if(k.children){const E=le(k,n);if(E){l.push(E);const C=Y(k,n);r+=C}}})}const f=document.createElement("h1");if(f.textContent=te(n,b,r),f.className="flex-start w-full font-semibold text-lg py-2 text-zinc-800 dark:text-zinc-50",o.appendChild(f),l.forEach(g=>{o.appendChild(g)}),window.updateBookmarkCards&&window.updateBookmarkCards(),r===0){const g=document.createElement("p");g.textContent=n?`No bookmarks found matching "${n}"`:"No bookmark folders found.",g.className="text-zinc-500 dark:text-zinc-400 mt-4",o.appendChild(g)}}});console.log("Keyboard shortcuts integrated into main.js");function Ae(){console.log("💾 Triggering save changes...");const t=window.currentBookmarkNode;if(!t){console.error("❌ No current bookmark node found");return}const o=document.getElementById("edit-title"),a=document.getElementById("edit-url"),i=document.getElementById("folder-dropdown");if(!o||!a||!i){console.error("❌ Edit modal inputs not found");return}const s=o.value.trim(),d=a.value.trim(),c=i.value;if(!s||!d){console.log("❌ Title or URL is empty");return}console.log("📝 Saving bookmark:",{newTitle:s,newUrl:d,newParentId:c}),chrome.bookmarks.update(t.id,{title:s,url:d},function(){console.log("✅ Updated bookmark title and URL"),c!==t.parentId?chrome.bookmarks.move(t.id,{parentId:c},function(){console.log("✅ Moved bookmark to new folder"),u()}):u()});function u(){if(console.log("✅ Save completed, closing modal"),window.closeEditModal)window.closeEditModal();else{const v=document.getElementById("edit-modal");v&&v.classList.add("hidden")}window.updateBookmarkCards&&window.updateBookmarkCards(),setTimeout(()=>{location.reload()},500)}}function ze(t){if(console.log("🔧 Triggering edit action for card:",t),!window.getBookmarkFromCard||!window.openEditModal){console.error("Required functions not available");return}const o=window.getBookmarkFromCard(t);console.log("📋 Extracted bookmark data:",o),o?(console.log("✅ Opening edit modal for:",o.title),console.log("📝 Full bookmark data being passed:",{id:o.id,title:o.title,url:o.url,parentId:o.parentId}),window.openEditModal(o),console.log("📝 Edit modal function called")):(console.error("❌ Could not extract bookmark data from card"),console.log("Card HTML:",t.outerHTML))}function Me(t){if(console.log("🗑️ Triggering delete action for card:",t),!window.getBookmarkFromCard||!window.deleteBookmark){console.error("Required functions not available");return}const o=window.getBookmarkFromCard(t);if(o&&confirm(`Are you sure you want to delete the bookmark "${o.title}"?`)){console.log("✅ Confirmed deletion of bookmark:",o.title);const a=Array.from(document.querySelectorAll(".card")),i=a.indexOf(t),s=a[i+1]||a[i-1];console.log("📍 Current card index:",i,"Next card found:",!!s),V(null),window.deleteBookmark(o),console.log("🗑️ Delete function called for bookmark"),setTimeout(()=>{window.updateBookmarkCards&&window.updateBookmarkCards();const d=Array.from(document.querySelectorAll(".card"));let c=null;if(s&&document.contains(s))c=s;else if(d.length>0){const u=Math.min(i,d.length-1);c=d[u]}c?(c.focus(),V(c),console.log("🎯 Focused and highlighted card after deletion:",c.querySelector("h3")?.textContent||"Unknown title")):console.log("❌ No card available to focus after deletion")},300)}else o?console.log("❌ User cancelled deletion"):console.error("❌ Could not extract bookmark data from card")}function De(t){if(console.log("📸 Triggering capture action for card:",t),!window.getBookmarkFromCard||!window.handleScreenshotCapture){console.error("Required functions not available");return}const o=window.getBookmarkFromCard(t);o?(console.log("✅ Using centralized capture for:",o.title,"URL:",o.url),window.handleScreenshotCapture(o.url,o.title,t)):console.error("❌ Could not extract bookmark data from card")}function Te(t){console.log("🔗 Triggering open URL for card:",t);const o=t.querySelector("a");o&&o.href?(console.log("Opening link:",o.href),window.open(o.href,"_blank")):console.log("No link found in card")}function V(t){document.querySelectorAll(".card").forEach(o=>{o.style.outline="",o.style.boxShadow=""}),t?(t.style.outline="3px solid #3b82f6",t.style.boxShadow="0 0 0 1px #3b82f6",console.log("🎯 Highlighted focused card:",t.querySelector("h3")?.textContent||"Unknown title")):console.log("🔄 Cleared all card highlights")}let Q=-1,P=[],re=[];function Ee(){P=Array.from(document.querySelectorAll(".card")),console.log("🔄 Updated bookmark cards array:",P.length,"cards found"),P.forEach((t,o)=>{t.setAttribute("tabindex","0"),t.setAttribute("data-bookmark-index",o)})}window.updateBookmarkCards=Ee;function we(){const t=document.querySelector(".absolute.z-10.flex.flex-col.bg-zinc-800.w-44.h-32.rounded");t&&(t.remove(),console.log("✅ Bookmark menu closed")),re=[],P[Q]&&P[Q].focus()}function Ue(){const t=[],o=document.getElementById("search-input"),a=document.getElementById("filter"),i=document.getElementById("recents-view"),s=document.getElementById("folder-view"),d=document.getElementById("settings-btn");o&&t.push(o),a&&t.push(a),i&&t.push(i),s&&t.push(s);const c=document.getElementById("folder-list");if(c){const u=Array.from(c.children);for(let v of u){const B=v.querySelectorAll("h1, h2");if(B.forEach(b=>{b.setAttribute("tabindex","0"),t.push(b);let L=null,x=b.nextElementSibling;for(;x&&!L;){if(x.classList&&x.classList.contains("card")){L=x;break}const A=x.querySelector?x.querySelector(".card"):null;if(A){L=A;break}x=x.nextElementSibling}L||(L=v.querySelector(".card")),L&&t.push(L)}),B.length===0){const b=v.querySelector(".card");b&&t.push(b)}}}return d&&t.push(d),t.filter(u=>u&&!u.hidden&&!u.disabled&&getComputedStyle(u).display!=="none")}function Fe(t){if(console.log("🧭 handleBookmarkNavigation called with key:",t.key),P.length===0)return console.log("❌ No bookmark cards found"),!1;const o=document.activeElement;console.log("🎯 Currently focused element:",o.tagName,"Classes:",o.className);const a=o.classList.contains("card");if(console.log("📋 Is bookmark card focused?",a),!a)return console.log("❌ Not focused on a bookmark card, skipping navigation"),!1;let i=null;if(i=o.closest('[class*="grid-cols"]'),i||(i=o.closest('[class*="grid"]')),i||(i=o.closest("#folder-list > *")),i||(i=document.getElementById("folder-list")),!i)return console.log("❌ Could not find parent container for navigation"),!1;console.log("🎯 Found parent container:",i.className);const s=Array.from(i.querySelectorAll(".card")),d=s.indexOf(o);if(d===-1)return console.log("❌ Current card not found in container"),!1;console.log("📍 Current card index:",d,"of",s.length,"cards");let c=d;const u=i.offsetWidth,v=240;let B=Math.max(1,Math.floor(u/v));if(i.classList.contains("grid")||i.className.includes("grid-cols")){const x=window.getComputedStyle(i).gridTemplateColumns;if(x&&x!=="none"){const A=x.split(" ").length;A>0&&(B=A,console.log("📊 Detected CSS grid with",B,"columns"))}}switch(console.log("📏 Container width:",u,"Card width:",v,"Cards per row:",B),t.key){case"ArrowRight":c=(d+1)%s.length,console.log("➡️ Moving right from",d,"to",c);break;case"ArrowLeft":c=d===0?s.length-1:d-1,console.log("⬅️ Moving left from",d,"to",c);break;case"ArrowDown":c=Math.min(d+B,s.length-1),console.log("⬇️ Moving down from",d,"to",c,"(+"+B+")");break;case"ArrowUp":c=Math.max(d-B,0),console.log("⬆️ Moving up from",d,"to",c,"(-"+B+")");break;default:return!1}t.preventDefault();const b=s[c];return b&&(Q=s.indexOf(b),b.focus(),V(b),b.scrollIntoView({behavior:"smooth",block:"nearest",inline:"nearest"})),!0}function $e(t){if(t.key!=="Tab")return!1;const o=document.getElementById("settings-modal");if(o&&!o.classList.contains("hidden"))return Re(t);const a=document.getElementById("edit-modal");if(a&&!a.classList.contains("hidden"))return qe(t);const i=Ue(),s=document.activeElement;let d=i.indexOf(s);if(d===-1&&s.classList.contains("card")){const v=s.closest('.grid, [class*="grid"]')||s.closest("#folder-list > *");if(v){const B=v.querySelector(".card");d=i.indexOf(B)}}d===-1&&(d=-1);let c;t.shiftKey?c=d<=0?i.length-1:d-1:c=(d+1)%i.length,t.preventDefault();const u=i[c];return u.classList.contains("card")?(Q=parseInt(u.getAttribute("data-bookmark-index")),V(u)):V(null),u.focus(),u.scrollIntoView&&u.scrollIntoView({behavior:"smooth",block:"nearest",inline:"nearest"}),!0}function qe(t){console.log("🔄 Edit modal tab navigation");const o=[document.getElementById("edit-title"),document.getElementById("edit-url"),document.getElementById("folder-dropdown"),document.getElementById("cancel-edit"),document.getElementById("save-edit")].filter(c=>c&&!c.disabled&&!c.hidden);if(console.log("📋 Modal elements found:",o.length),o.length===0)return console.log("❌ No focusable elements found in modal"),!1;const a=document.activeElement;let i=o.indexOf(a);console.log("🎯 Current element index:",i,"Element:",a.id||a.tagName);let s;t.shiftKey?(s=i<=0?o.length-1:i-1,console.log("⬅️ Shift+Tab: moving to index",s)):(s=(i+1)%o.length,console.log("➡️ Tab: moving to index",s)),t.preventDefault(),t.stopPropagation();const d=o[s];return d&&(d.focus(),console.log("✅ Focused element:",d.id||d.tagName)),!0}function Re(t){console.log("🔄 Settings modal tab navigation");const o=[document.querySelector('button[data-theme="auto"]'),document.querySelector('button[data-theme="light"]'),document.querySelector('button[data-theme="dark"]'),document.querySelector('a[href="https://tally.so/r/n0xjLP"]'),document.querySelector('a[href="https://www.buymeacoffee.com/snmbala"]')].filter(c=>c&&!c.disabled&&!c.hidden);if(console.log("⚙️ Settings modal elements found:",o.length),o.length===0)return console.log("❌ No focusable elements found in settings modal"),!1;const a=document.activeElement;let i=o.indexOf(a);console.log("🎯 Current settings element index:",i,"Element:",a.textContent||a.tagName);let s;t.shiftKey?(s=i<=0?o.length-1:i-1,console.log("⬅️ Shift+Tab: moving to index",s)):(s=(i+1)%o.length,console.log("➡️ Tab: moving to index",s)),t.preventDefault(),t.stopPropagation();const d=o[s];return d&&(d.focus(),console.log("✅ Focused settings element:",d.textContent||d.tagName)),!0}function Ne(){console.log("Setting up integrated keyboard event listeners..."),document.addEventListener("keydown",function(t){console.log("Key pressed:",t.key,"Target:",t.target.tagName,"ID:",t.target.id,"Classes:",t.target.className);const o=document.getElementById("edit-modal");if(o&&!o.classList.contains("hidden")&&t.key==="Enter"&&(t.target.id==="edit-title"||t.target.id==="edit-url"||t.target.id==="save-edit")){console.log("💾 Enter key pressed in edit modal - saving changes"),t.preventDefault(),t.stopPropagation(),Ae();return}const a=document.activeElement;if(a&&a.classList.contains("card")){if(V(a),t.key.toLowerCase()==="e"){console.log("✏️ E key pressed - opening edit modal"),t.preventDefault(),ze(a);return}if(t.key==="Delete"||t.key==="Backspace"){console.log("🗑️ Delete key pressed - deleting bookmark"),t.preventDefault(),Me(a);return}if(t.key.toLowerCase()==="c"){console.log("📸 C key pressed - capturing screenshot"),t.preventDefault(),De(a);return}if(t.key==="Enter"){console.log("🔗 Enter key pressed - opening bookmark link"),t.preventDefault(),Te(a);return}}else console.log("🔍 Active element is not a card. Element:",a.tagName,"Classes:",a.className);if(!$e(t)){if(Fe(t)){re.length>0&&we();return}if(t.key==="Escape"){console.log("Escape key pressed - unfocusing elements"),console.log("Current active element:",document.activeElement.tagName,document.activeElement.id),t.preventDefault();const i=document.getElementById("edit-modal");if(i&&!i.classList.contains("hidden")){window.closeEditModal?window.closeEditModal():(i.classList.add("hidden"),window.lastFocusedElement&&document.contains(window.lastFocusedElement)&&(window.lastFocusedElement.focus(),window.lastFocusedElement=null)),console.log("Closed edit modal");return}const s=document.getElementById("settings-modal");if(s&&!s.classList.contains("hidden")){s.classList.add("hidden");const u=document.getElementById("settings-btn");u&&(u.focus(),console.log("🎯 Restored focus to settings button")),console.log("Closed settings modal");return}if(re.length>0){we();return}const d=document.getElementById("search-input");if(d&&document.activeElement===d){d.blur(),console.log("Unfocused search input");return}const c=document.getElementById("filter");if(c&&document.activeElement===c){c.blur(),console.log("Unfocused filter dropdown");return}if(document.activeElement&&document.activeElement!==document.body){document.activeElement.blur(),console.log("Unfocused active element:",document.activeElement.tagName);return}console.log("No element to unfocus");return}if((t.target.tagName==="INPUT"||t.target.tagName==="TEXTAREA"||t.target.isContentEditable)&&t.target.id!=="filter"){console.log("Skipping - user is typing in input field");return}if(t.key.toLowerCase()==="s"){console.log("S key pressed - focusing search"),t.preventDefault(),window.scrollTo({top:0,behavior:"smooth"});const i=document.getElementById("search-input");i&&(i.focus(),i.value&&i.select());return}if(t.key.toLowerCase()==="f"){console.log("F key pressed - toggling filter"),t.preventDefault(),window.scrollTo({top:0,behavior:"smooth"});const i=document.getElementById("filter");if(i)if(document.activeElement===i)i.blur();else if(i.focus(),i.showPicker)i.showPicker();else{const s=i.getBoundingClientRect(),d=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!0,clientX:s.left+s.width-20,clientY:s.top+s.height/2});i.dispatchEvent(d)}return}if(t.key.toLowerCase()==="r"){console.log("R key pressed - refreshing page"),t.preventDefault(),window.location.reload();return}if(t.key.toLowerCase()==="h"){console.log("H key pressed - opening settings"),t.preventDefault();const i=document.getElementById("settings-btn"),s=document.getElementById("settings-modal");i&&s&&i.click();return}if(t.key==="/"){const i=document.getElementById("search-input");i&&document.activeElement!==i&&(t.preventDefault(),i.focus())}}})}function ke(){console.log("Initializing integrated keyboard shortcuts..."),Ne();const t=new MutationObserver(()=>{Ee()}),o=document.getElementById("folder-list");o&&(t.observe(o,{childList:!0,subtree:!0}),console.log("DOM observer set up for folder-list"))}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",ke):setTimeout(ke,100);
